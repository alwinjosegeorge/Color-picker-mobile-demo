<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TrueShade Pro — Color Detector</title>
  <meta name="description" content="Professional color detection — live camera + upload, lock point, continuous tracking, magnifier, persistent history, export CSV/JSON."/>
  <style>
    :root{
      --bg1:#071029; --bg2:#0f1724;
      --glass: rgba(255,255,255,0.03);
      --muted: rgba(255,255,255,0.75);
      --accent1:#7c3aed;
      --accent2:#4f46e5;
      --success:#10b981;
      --danger:#ef4444;
      --radius:14px;
      --ui-font: Inter, system-ui, "Segoe UI", Roboto, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:var(--ui-font);background:linear-gradient(180deg,var(--bg2),var(--bg1));color:#eef2ff;display:flex;align-items:center;justify-content:center;padding:18px}
    .app{width:1000px;max-width:98vw;border-radius:18px;padding:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 18px 50px rgba(2,6,23,0.7);border:1px solid rgba(255,255,255,0.02)}
    .top{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;color:white}
    .title{font-size:18px;font-weight:800}
    .subtitle{font-size:12px;color:var(--muted)}

    .main{display:grid;grid-template-columns:1fr 360px;gap:14px}
    .stage{background:#000;border-radius:14px;min-height:620px;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
    .controls-bar{display:flex;gap:8px;align-items:center;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-bottom:1px solid rgba(255,255,255,0.02)}
    .btn{padding:10px 12px;border-radius:10px;background:var(--glass);border:1px solid rgba(255,255,255,0.02);color:#eef2ff;font-weight:700;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));box-shadow:0 8px 24px rgba(79,70,229,0.12)}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
    .btn.success{background:linear-gradient(90deg,var(--success),#059669)}
    .btn.danger{background:linear-gradient(90deg,var(--danger),#b91c1c)}
    .mode-switch{margin-left:auto;display:flex;gap:6px;align-items:center}
    .toggle{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--muted)}
    input[type=file]{display:none}

    .stage-body{position:relative;height:520px;display:flex;align-items:center;justify-content:center}
    video, .preview-img, canvas{max-width:100%;width:100%;height:100%;object-fit:cover;display:block}
    .preview-img{display:block;width:100%;height:100%;object-fit:contain;background:#0b0b0b}
    .center-cross{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:84px;height:84px;border-radius:18px;border:2px dashed rgba(255,255,255,0.6);display:flex;align-items:center;justify-content:center;z-index:25;pointer-events:none}
    .center-dot{width:12px;height:12px;border-radius:50%;background:rgba(255,255,255,0.95);box-shadow:0 2px 8px rgba(0,0,0,0.6)}
    .floating-chip{position:absolute;left:50%;transform:translateX(-50%);bottom:78px;background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015));padding:10px 14px;border-radius:999px;display:flex;align-items:center;gap:12px;border:1px solid rgba(255,255,255,0.02);backdrop-filter: blur(6px);z-index:30;transition:opacity .15s,transform .15s}
    .floating-chip.hidden{opacity:0;transform:translateX(-50%) translateY(8px);pointer-events:none}
    .swatch{width:28px;height:28px;border-radius:8px;border:1px solid rgba(0,0,0,0.2);box-shadow:0 6px 18px rgba(0,0,0,0.5)}
    .fps{font-size:12px;color:var(--muted);margin-left:8px}

    .magnifier{
      position:absolute;width:120px;height:120px;border-radius:12px;border:2px solid rgba(255,255,255,0.06);overflow:hidden;z-index:40;display:none;background:#000;
      box-shadow:0 8px 30px rgba(2,6,23,0.6);
    }
    .magnifier canvas{width:100%;height:100%;display:block;transform-origin:center}

    .panel{padding:12px;display:flex;flex-direction:column;gap:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
    .big-color{display:flex;gap:12px;align-items:center}
    .big-swatch{width:72px;height:72px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
    .big-meta{flex:1}
    .color-name{font-weight:900;font-size:18px}
    .color-sub{font-size:13px;color:var(--muted);margin-top:6px}
    .meta-row{display:flex;gap:8px;align-items:center;margin-top:10px}
    .hex{font-weight:900;background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:8px}
    .copy-small{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03);cursor:pointer;border:1px solid rgba(255,255,255,0.02)}

    .history-list{display:flex;flex-direction:column;gap:8px;max-height:300px;overflow:auto;padding-right:6px}
    .history-item{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;background:rgba(0,0,0,0.16);cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
    .hist-swatch{width:48px;height:48px;border-radius:8px;flex-shrink:0}
    .hist-meta{flex:1}
    .hist-name{font-weight:800}
    .hist-sub{font-size:12px;color:var(--muted)}

    .footer-note{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}

    @media(max-width:920px){
      .main{grid-template-columns:1fr;gap:12px}
      .stage{order:2}
      .panel{order:1}
      .floating-chip{bottom:auto;top:18px;left:50%;transform:translateX(-50%);width:calc(100% - 48px);justify-content:flex-start}
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="TrueShade Pro color detector">
    <div class="top">
      <div class="logo">TS</div>
      <div>
        <div class="title">TrueShade Pro</div>
        <div class="subtitle">Live camera + Upload — accurate color naming</div>
      </div>
    </div>

    <div class="main">
      <div class="stage">
        <div class="controls-bar">
          <button class="btn primary" id="startStopBtn">Start Camera</button>
          <button class="btn" id="detectNowBtn">Detect Now</button>

          <label class="btn ghost" for="uploadInput">Upload Image
            <input id="uploadInput" type="file" accept="image/*" aria-label="Upload image" />
          </label>

          <button class="btn" id="lockPointBtn" title="Lock the current point (click/tap to set)">Lock Point: Off</button>

          <div class="mode-switch">
            <label class="toggle"><input id="modeCamera" name="mode" type="radio" checked> Camera</label>
            <label class="toggle"><input id="modeUpload" name="mode" type="radio"> Upload</label>
            <div style="width:12px"></div>
            <label class="toggle"><input id="continuousToggle" type="checkbox"> Continuous</label>
          </div>

          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <div class="fps" id="fps">— FPS</div>
            <button class="btn" id="exportHistory">Export</button>
            <button class="btn" id="clearHistory">Clear</button>
          </div>
        </div>

        <div class="stage-body" id="stageBody" aria-live="polite">
          <video id="video" autoplay playsinline style="display:none"></video>
          <img id="previewImg" class="preview-img" alt="Uploaded preview" style="display:none"/>
          <canvas id="buffer" style="display:none"></canvas>

          <div class="center-cross" aria-hidden="true"><div class="center-dot"></div></div>
          <div class="floating-chip hidden" id="floatingChip" aria-atomic="true" role="status">
            <div class="swatch" id="chipSwatch" style="background:#ff0000"></div>
            <div>
              <div style="font-weight:800" id="chipName">Red</div>
              <div style="font-size:13px;color:var(--muted)" id="chipMeta">RGB (255,0,0) · #FF0000</div>
            </div>
          </div>

          <div class="magnifier" id="magnifier" aria-hidden="true">
            <canvas id="magnCanvas"></canvas>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="card big-color">
          <div class="big-swatch" id="bigSwatch" style="background:#ff0000"></div>
          <div class="big-meta">
            <div class="color-name" id="colorName">Red</div>
            <div class="color-sub" id="colorSub">RGB (255, 0, 0) · HEX #FF0000</div>

            <div class="meta-row">
              <div class="hex" id="hexLabel">#FF0000</div>
              <button class="copy-small" id="copyHex">Copy HEX</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:800">History</div>
            <div style="font-size:13px;color:var(--muted)">Click to apply · Copy quick</div>
          </div>
          <div class="history-list" id="historyList" aria-live="polite"></div>
        </div>

        <div class="card" style="text-align:center">
          <div style="font-weight:800">Tips</div>
          <div class="footer-note">Upload stops camera automatically. Click/tap stage to pick or set the locked standard. Continuous = live tracking.</div>
        </div>
      </div>
    </div>

    <div class="footer-note" style="margin-top:10px">Made with ❤️ — TrueShade Pro</div>
  </div>

  <div aria-live="polite" id="srLive" style="position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden;"></div>

  <script>
    // ---------- Full CSS Colors (approx 140) ----------
    const CSS_COLORS = {
      "AliceBlue":"#F0F8FF","AntiqueWhite":"#FAEBD7","Aqua":"#00FFFF","Aquamarine":"#7FFFD4","Azure":"#F0FFFF",
      "Beige":"#F5F5DC","Bisque":"#FFE4C4","Black":"#000000","BlanchedAlmond":"#FFEBCD","Blue":"#0000FF",
      "BlueViolet":"#8A2BE2","Brown":"#A52A2A","BurlyWood":"#DEB887","CadetBlue":"#5F9EA0","Chartreuse":"#7FFF00",
      "Chocolate":"#D2691E","Coral":"#FF7F50","CornflowerBlue":"#6495ED","Cornsilk":"#FFF8DC","Crimson":"#DC143C",
      "Cyan":"#00FFFF","DarkBlue":"#00008B","DarkCyan":"#008B8B","DarkGoldenRod":"#B8860B","DarkGray":"#A9A9A9",
      "DarkGreen":"#006400","DarkKhaki":"#BDB76B","DarkMagenta":"#8B008B","DarkOliveGreen":"#556B2F","DarkOrange":"#FF8C00",
      "DarkOrchid":"#9932CC","DarkRed":"#8B0000","DarkSalmon":"#E9967A","DarkSeaGreen":"#8FBC8F","DarkSlateBlue":"#483D8B",
      "DarkSlateGray":"#2F4F4F","DarkTurquoise":"#00CED1","DarkViolet":"#9400D3","DeepPink":"#FF1493","DeepSkyBlue":"#00BFFF",
      "DimGray":"#696969","DodgerBlue":"#1E90FF","FireBrick":"#B22222","FloralWhite":"#FFFAF0","ForestGreen":"#228B22",
      "Fuchsia":"#FF00FF","Gainsboro":"#DCDCDC","GhostWhite":"#F8F8FF","Gold":"#FFD700","GoldenRod":"#DAA520",
      "Gray":"#808080","Green":"#008000","GreenYellow":"#ADFF2F","HoneyDew":"#F0FFF0","HotPink":"#FF69B4",
      "IndianRed":"#CD5C5C","Indigo":"#4B0082","Ivory":"#FFFFF0","Khaki":"#F0E68C","Lavender":"#E6E6FA",
      "LavenderBlush":"#FFF0F5","LawnGreen":"#7CFC00","LemonChiffon":"#FFFACD","LightBlue":"#ADD8E6","LightCoral":"#F08080",
      "LightCyan":"#E0FFFF","LightGoldenRodYellow":"#FAFAD2","LightGray":"#D3D3D3","LightGreen":"#90EE90","LightPink":"#FFB6C1",
      "LightSalmon":"#FFA07A","LightSeaGreen":"#20B2AA","LightSkyBlue":"#87CEFA","LightSlateGray":"#778899","LightSteelBlue":"#B0C4DE",
      "LightYellow":"#FFFFE0","Lime":"#00FF00","LimeGreen":"#32CD32","Linen":"#FAF0E6","Magenta":"#FF00FF",
      "Maroon":"#800000","MediumAquaMarine":"#66CDAA","MediumBlue":"#0000CD","MediumOrchid":"#BA55D3","MediumPurple":"#9370DB",
      "MediumSeaGreen":"#3CB371","MediumSlateBlue":"#7B68EE","MediumSpringGreen":"#00FA9A","MediumTurquoise":"#48D1CC","MediumVioletRed":"#C71585",
      "MidnightBlue":"#191970","MintCream":"#F5FFFA","MistyRose":"#FFE4E1","Moccasin":"#FFE4B5","NavajoWhite":"#FFDEAD",
      "Navy":"#000080","OldLace":"#FDF5E6","Olive":"#808000","OliveDrab":"#6B8E23","Orange":"#FFA500",
      "OrangeRed":"#FF4500","Orchid":"#DA70D6","PaleGoldenRod":"#EEE8AA","PaleGreen":"#98FB98","PaleTurquoise":"#AFEEEE",
      "PaleVioletRed":"#DB7093","PapayaWhip":"#FFEFD5","PeachPuff":"#FFDAB9","Peru":"#CD853F","Pink":"#FFC0CB",
      "Plum":"#DDA0DD","PowderBlue":"#B0E0E6","Purple":"#800080","RebeccaPurple":"#663399","Red":"#FF0000",
      "RosyBrown":"#BC8F8F","RoyalBlue":"#4169E1","SaddleBrown":"#8B4513","Salmon":"#FA8072","SandyBrown":"#F4A460",
      "SeaGreen":"#2E8B57","SeaShell":"#FFF5EE","Sienna":"#A0522D","Silver":"#C0C0C0","SkyBlue":"#87CEEB",
      "SlateBlue":"#6A5ACD","SlateGray":"#708090","Snow":"#FFFAFA","SpringGreen":"#00FF7F","SteelBlue":"#4682B4",
      "Tan":"#D2B48C","Teal":"#008080","Thistle":"#D8BFD8","Tomato":"#FF6347","Turquoise":"#40E0D0",
      "Violet":"#EE82EE","Wheat":"#F5DEB3","White":"#FFFFFF","WhiteSmoke":"#F5F5F5","Yellow":"#FFFF00","YellowGreen":"#9ACD32"
    };

    // ---------- Color math: RGB -> Lab, deltaE76 ----------
    function rgbToXyz(r,g,b){
      r/=255; g/=255; b/=255;
      r = r > 0.04045 ? Math.pow((r+0.055)/1.055,2.4) : r/12.92;
      g = g > 0.04045 ? Math.pow((g+0.055)/1.055,2.4) : g/12.92;
      b = b > 0.04045 ? Math.pow((b+0.055)/1.055,2.4) : b/12.92;
      return [
        (r*0.4124 + g*0.3576 + b*0.1805) * 100,
        (r*0.2126 + g*0.7152 + b*0.0722) * 100,
        (r*0.0193 + g*0.1192 + b*0.9505) * 100
      ];
    }
    function xyzToLab(x,y,z){
      const refX = 95.047, refY = 100.000, refZ = 108.883;
      x /= refX; y /= refY; z /= refZ;
      x = x > 0.008856 ? Math.cbrt(x) : (7.787 * x) + (16/116);
      y = y > 0.008856 ? Math.cbrt(y) : (7.787 * y) + (16/116);
      z = z > 0.008856 ? Math.cbrt(z) : (7.787 * z) + (16/116);
      return [ (116 * y) - 16, 500 * (x - y), 200 * (y - z) ];
    }
    function rgbToLab(r,g,b){
      return xyzToLab(...rgbToXyz(r,g,b));
    }
    function deltaE76(labA, labB){
      const dl = labA[0]-labB[0], da = labA[1]-labB[1], db = labA[2]-labB[2];
      return Math.sqrt(dl*dl + da*da + db*db);
    }

    // ---------- Find closest named color ----------
    const CALC_CACHE = {};
    function closestColorName(r,g,b){
      const key = `${r},${g},${b}`;
      if(CALC_CACHE[key]) return CALC_CACHE[key];
      const lab = rgbToLab(r,g,b);
      let best = {name:'',hex:'#000000',dist:Infinity};
      for(const [name,hex] of Object.entries(CSS_COLORS)){
        const R = parseInt(hex.substr(1,2),16), G = parseInt(hex.substr(3,2),16), B = parseInt(hex.substr(5,2),16);
        const dist = deltaE76(lab, rgbToLab(R,G,B));
        if(dist < best.dist){ best = {name,hex,dist}; }
      }
      CALC_CACHE[key] = best;
      return best;
    }

    // ---------- DOM refs ----------
    const startStopBtn = document.getElementById('startStopBtn');
    const detectNowBtn = document.getElementById('detectNowBtn');
    const uploadInput = document.getElementById('uploadInput');
    const modeCamera = document.getElementById('modeCamera');
    const modeUpload = document.getElementById('modeUpload');
    const continuousToggle = document.getElementById('continuousToggle');

    const video = document.getElementById('video');
    const previewImg = document.getElementById('previewImg');
    const buffer = document.getElementById('buffer');
    const magnCanvas = document.getElementById('magnCanvas');
    const magnifier = document.getElementById('magnifier');

    const floatingChip = document.getElementById('floatingChip');
    const chipSwatch = document.getElementById('chipSwatch');
    const chipName = document.getElementById('chipName');
    const chipMeta = document.getElementById('chipMeta');

    const bigSwatch = document.getElementById('bigSwatch');
    const colorNameEl = document.getElementById('colorName');
    const colorSubEl = document.getElementById('colorSub');
    const hexLabel = document.getElementById('hexLabel');
    const copyHexBtn = document.getElementById('copyHex');
    const exportBtn = document.getElementById('exportHistory');
    const clearBtn = document.getElementById('clearHistory');
    const historyList = document.getElementById('historyList');
    const fpsEl = document.getElementById('fps');
    const srLive = document.getElementById('srLive');
    const stageBody = document.getElementById('stageBody');
    const lockPointBtn = document.getElementById('lockPointBtn');

    let stream = null;
    let anim = null;
    let fpsCounter = {frames:0, lastTime: performance.now()};
    let history = [];

    const bufferCtx = buffer.getContext('2d');
    const magnCtx = magnCanvas.getContext('2d');

    // lock point state (stored as percent of buffer)
    let lockEnabled = false;
    let lockedPerc = {x:0.5, y:0.5}; // default center

    // helpers
    function rgbToHex(r,g,b){ return "#" + [r,g,b].map(v=> v.toString(16).padStart(2,'0')).join('').toUpperCase(); }
    function clamp(v){ return Math.max(0,Math.min(255,Math.round(v))); }

    function updateDisplay(r,g,b, save=true){
      r = clamp(r); g = clamp(g); b = clamp(b);
      const hex = rgbToHex(r,g,b);
      const found = closestColorName(r,g,b);
      colorNameEl.textContent = found.name;
      colorSubEl.textContent = `RGB (${r}, ${g}, ${b}) · HEX ${hex}`;
      hexLabel.textContent = hex;
      bigSwatch.style.background = `rgb(${r}, ${g}, ${b})`;
      chipSwatch.style.background = `rgb(${r}, ${g}, ${b})`;
      chipName.textContent = found.name;
      chipMeta.textContent = `RGB (${r}, ${g}, ${b}) · ${hex}`;

      // announce to screen reader
      srLive.textContent = `Detected ${found.name}, ${hex}, RGB ${r} ${g} ${b}`;

      if(save) {
        pushHistory(found.name, r,g,b, hex);
        persistHistory();
      }
    }

    function pushHistory(name,r,g,b,hex){
      history.unshift({name,hex,time:new Date().toISOString()});
      if(history.length>40) history.length=40;
      renderHistory();
    }

    function renderHistory(){
      historyList.innerHTML = '';
      for(let i=0;i<history.length;i++){
        const h = history[i];
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `<div class="hist-swatch" style="background:${h.hex}"></div>
                          <div class="hist-meta"><div class="hist-name">${h.name}</div><div class="hist-sub">${h.hex} · ${h.time.split('T')[1].slice(0,8)}</div></div>
                          <button class="copy-small" data-idx="${i}">Copy</button>`;
        item.addEventListener('click', (ev)=>{
          if(ev.target && ev.target.matches('button.copy-small')) return;
          const hex = h.hex.replace('#','');
          const r = parseInt(hex.slice(0,2),16), g = parseInt(hex.slice(2,4),16), b = parseInt(hex.slice(4,6),16);
          updateDisplay(r,g,b,false);
        });
        item.querySelector('button.copy-small').addEventListener('click', (ev)=>{
          ev.stopPropagation();
          navigator.clipboard.writeText(h.hex).then(()=> {
            const btn = ev.target;
            const old = btn.textContent; btn.textContent = 'Copied';
            setTimeout(()=> btn.textContent = old,900);
          });
        });
        historyList.appendChild(item);
      }
    }

    function persistHistory(){
      try{ localStorage.setItem('ts_history_v3', JSON.stringify(history)); }catch(e){}
    }
    function loadHistory(){
      try{
        const raw = localStorage.getItem('ts_history_v3');
        if(raw) history = JSON.parse(raw);
      }catch(e){}
      renderHistory();
    }

    // camera control
    async function startCamera(){
      try{
        if(previewImg.style.display !== 'none'){
          previewImg.style.display = 'none';
          previewImg.src = '';
          modeCamera.checked = true; modeUpload.checked = false;
        }
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
        video.srcObject = stream;
        video.style.display = '';
        startStopBtn.textContent = 'Stop Camera';
        setupDetectLoop();
      }catch(err){
        alert('Camera access denied or not available. Use upload instead.');
        console.error(err);
      }
    }

    function stopCamera(){
      if(stream){
        stream.getTracks().forEach(t=> t.stop());
        stream = null;
      }
      video.srcObject = null;
      video.style.display = 'none';
      startStopBtn.textContent = 'Start Camera';
      cancelAnimationFrame(anim); anim = null;
      fpsEl.textContent = '— FPS';
    }

    startStopBtn.addEventListener('click', ()=>{ if(!stream) startCamera(); else stopCamera(); });

    // detection loop
    function setupDetectLoop(){
      if(anim) return;
      const loop = (t)=>{
        anim = requestAnimationFrame(loop);
        fpsCounter.frames++;
        const elapsed = t - fpsCounter.lastTime;
        if(elapsed > 500){
          const fps = Math.round((fpsCounter.frames/(elapsed/1000)));
          fpsEl.textContent = `${fps} FPS`;
          fpsCounter.lastTime = t; fpsCounter.frames = 0;
        }
        if(continuousToggle.checked){
          detectPoint(); // respects lock or center
        }
      };
      anim = requestAnimationFrame(loop);
    }

    // detect using either locked point, center or provided point
    function detectPoint(){ 
      const bufW = buffer.width || (video.videoWidth || stageBody.clientWidth);
      const bufH = buffer.height || (video.videoHeight || stageBody.clientHeight);

      if(stream && video.videoWidth){
        buffer.width = video.videoWidth; buffer.height = video.videoHeight;
        bufferCtx.drawImage(video,0,0,buffer.width,buffer.height);
      } else if(previewImg.style.display !== 'none'){
        buffer.width = previewImg.naturalWidth || previewImg.width;
        buffer.height = previewImg.naturalHeight || previewImg.height;
        bufferCtx.drawImage(previewImg,0,0,buffer.width,buffer.height);
      } else {
        return;
      }

      let bx, by;
      if(lockEnabled){
        bx = Math.floor(lockedPerc.x * buffer.width);
        by = Math.floor(lockedPerc.y * buffer.height);
      } else {
        bx = Math.floor(buffer.width/2);
        by = Math.floor(buffer.height/2);
      }
      try{
        const p = bufferCtx.getImageData(bx,by,1,1).data;
        updateDisplay(p[0],p[1],p[2]);
        showFloating();
      }catch(e){}
    }

    // show floating chip briefly
    function showFloating(){
      floatingChip.classList.remove('hidden');
      clearTimeout(floatingChip._hide);
      floatingChip._hide = setTimeout(()=> floatingChip.classList.add('hidden'), 1100);
    }

    detectNowBtn.addEventListener('click', ()=>{ detectPoint(); if(!anim && stream) setupDetectLoop(); });

    // file upload behavior: stop camera automatically and show preview; detect center of uploaded image
    uploadInput.addEventListener('change', (ev)=>{
      const f = ev.target.files[0];
      if(!f) return;
      if(stream) stopCamera();
      const url = URL.createObjectURL(f);
      previewImg.onload = ()=>{
        previewImg.style.display = '';
        video.style.display = 'none';
        modeUpload.checked = true;
        modeCamera.checked = false;
        buffer.width = previewImg.naturalWidth;
        buffer.height = previewImg.naturalHeight;
        bufferCtx.drawImage(previewImg,0,0,buffer.width,buffer.height);
        if(!lockEnabled){
          lockedPerc.x = 0.5; lockedPerc.y = 0.5;
        }
        detectPoint();
        URL.revokeObjectURL(url);
      };
      previewImg.onerror = ()=> alert('Failed to load image');
      previewImg.src = url;
    });

    // pointer/magnifier logic (works for mouse & touch)
    function handlePointerMove(clientX, clientY){
      const rect = stageBody.getBoundingClientRect();
      const x = clientX - rect.left, y = clientY - rect.top;
      const show = (previewImg.style.display !== 'none') || (video.style.display !== 'none' && video.videoWidth);
      if(!show){ magnifier.style.display = 'none'; return; }
      magnifier.style.display = 'block';
      let left = clientX + 14;
      if(left + magnifier.offsetWidth > window.innerWidth - 24) left = clientX - magnifier.offsetWidth - 14;
      magnifier.style.left = left + 'px';
      magnifier.style.top = (clientY - magnifier.offsetHeight/2) + 'px';

      const displayW = stageBody.clientWidth, displayH = stageBody.clientHeight;
      const bufW = buffer.width || (video.videoWidth || displayW), bufH = buffer.height || (video.videoHeight || displayH);
      const scaleX = bufW / displayW, scaleY = bufH / displayH;
      const sampleSize = 60;
      const bx = Math.floor(x * scaleX - sampleSize/2);
      const by = Math.floor(y * scaleY - sampleSize/2);
      magnCanvas.width = 120; magnCanvas.height = 120;
      try{
        const sx = Math.max(0, bx), sy = Math.max(0, by);
        const sWidth = Math.min(sampleSize, bufW - sx), sHeight = Math.min(sampleSize, bufH - sy);
        magnCtx.imageSmoothingEnabled = false;
        magnCtx.clearRect(0,0,magnCanvas.width,magnCanvas.height);
        magnCtx.drawImage(buffer, sx, sy, sWidth, sHeight, 0,0, magnCanvas.width, magnCanvas.height);
        magnCtx.strokeStyle = 'rgba(255,255,255,0.9)'; magnCtx.lineWidth = 2;
        magnCtx.beginPath(); magnCtx.moveTo(60,0); magnCtx.lineTo(60,120); magnCtx.moveTo(0,60); magnCtx.lineTo(120,60); magnCtx.stroke();
      }catch(e){}
    }

    stageBody.addEventListener('mousemove', (e)=> { handlePointerMove(e.clientX, e.clientY); });
    stageBody.addEventListener('touchmove', (e)=>{ if(e.touches && e.touches[0]){ handlePointerMove(e.touches[0].clientX, e.touches[0].clientY); } });
    stageBody.addEventListener('mouseleave', ()=> { magnifier.style.display = 'none'; });

    // click to pick / set locked point
    stageBody.addEventListener('click', (e)=>{
      const rect = stageBody.getBoundingClientRect();
      const x = e.clientX - rect.left, y = e.clientY - rect.top;
      const displayW = stageBody.clientWidth, displayH = stageBody.clientHeight;
      const bufW = buffer.width || (video.videoWidth || displayW), bufH = buffer.height || (video.videoHeight || displayH);
      const scaleX = bufW / displayW, scaleY = bufH / displayH;
      const bx = Math.floor(x * scaleX), by = Math.floor(y * scaleY);

      if(lockEnabled){
        lockedPerc.x = bx / bufW; lockedPerc.y = by / bufH;
        const cross = document.querySelector('.center-cross');
        cross.style.left = `${x}px`; cross.style.top = `${y}px`; cross.style.transform = 'translate(-50%,-50%)';
        detectPoint(); showFloating();
        return;
      }

      try{
        const p = bufferCtx.getImageData(bx,by,1,1).data;
        updateDisplay(p[0], p[1], p[2]);
        showFloating();
      }catch(err){
        if(stream && video.videoWidth){
          buffer.width = video.videoWidth; buffer.height = video.videoHeight;
          bufferCtx.drawImage(video,0,0);
          try{
            const p = bufferCtx.getImageData(bx,by,1,1).data;
            updateDisplay(p[0],p[1],p[2]); showFloating();
          }catch(e){}
        }
      }
    });

    stageBody.addEventListener('touchend', (e)=>{
      if(!e.changedTouches || !e.changedTouches[0]) return;
      const t = e.changedTouches[0];
      const rect = stageBody.getBoundingClientRect();
      const x = t.clientX - rect.left, y = t.clientY - rect.top;
      const displayW = stageBody.clientWidth, displayH = stageBody.clientHeight;
      const bufW = buffer.width || (video.videoWidth || displayW), bufH = buffer.height || (video.videoHeight || displayH);
      const bx = Math.floor(x * (bufW/displayW)), by = Math.floor(y * (bufH/displayH));
      if(lockEnabled){
        lockedPerc.x = bx / bufW; lockedPerc.y = by / bufH; detectPoint(); showFloating(); return;
      }
      try{ const p = bufferCtx.getImageData(bx, by,1,1).data; updateDisplay(p[0],p[1],p[2]); showFloating(); }catch(e){}
    });

    // lock point toggle
    lockPointBtn.addEventListener('click', ()=>{
      lockEnabled = !lockEnabled;
      lockPointBtn.textContent = `Lock Point: ${lockEnabled? 'On' : 'Off'}`;
      lockPointBtn.style.background = lockEnabled ? 'linear-gradient(90deg,#10b981,#059669)' : '';
      if(lockEnabled){
        const bufW = buffer.width || (video.videoWidth || stageBody.clientWidth);
        const bufH = buffer.height || (video.videoHeight || stageBody.clientHeight);
        lockedPerc.x = 0.5; lockedPerc.y = 0.5;
      } else {
        const cross = document.querySelector('.center-cross');
        cross.style.left = '50%'; cross.style.top = '50%'; cross.style.transform = 'translate(-50%,-50%)';
      }
    });

    // copy hex
    copyHexBtn.addEventListener('click', ()=>{
      const txt = hexLabel.textContent.trim();
      navigator.clipboard.writeText(txt).then(()=> {
        copyHexBtn.textContent = 'Copied';
        setTimeout(()=> copyHexBtn.textContent = 'Copy HEX',900);
      });
    });

    // export history
    exportBtn.addEventListener('click', ()=>{
      if(!history.length){ alert('No history to export'); return; }
      let fmt = prompt('Export format? Type "csv" or "json" (default json):','json');
      if(!fmt) fmt = 'json';
      fmt = fmt.toLowerCase().trim();
      if(fmt === 'csv'){
        const rows = [['name','hex','time']];
        for(const h of history) rows.push([h.name,h.hex,h.time]);
        const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'trueShade_history.csv'; a.click(); URL.revokeObjectURL(url);
      } else {
        const compact = history.map(h => ({name:h.name,hex:h.hex,time:h.time}));
        const blob = new Blob([JSON.stringify(compact, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'trueShade_history.json'; a.click(); URL.revokeObjectURL(url);
      }
    });

    // clear history
    clearBtn.addEventListener('click', ()=>{
      if(confirm('Clear color history?')){ history = []; persistHistory(); renderHistory(); }
    });

    // stop camera on unload
    window.addEventListener('beforeunload', ()=> { if(stream) stopCamera(); });

    // initial tip
    setTimeout(()=> {
      if(!localStorage.getItem('ts_seen_v3')){
        alert('Tip: Upload stops camera automatically. Click/tap stage to pick or to set the locked standard. Use Continuous for live tracking.');
        localStorage.setItem('ts_seen_v3','1');
      }
    },700);

    // keep buffer updated when video is playing
    video.addEventListener('play', function(){
      const tick = ()=>{ if(video.paused || video.ended) return; if(video.videoWidth){ buffer.width = video.videoWidth; buffer.height = video.videoHeight; bufferCtx.drawImage(video,0,0, buffer.width, buffer.height); } requestAnimationFrame(tick); };
      requestAnimationFrame(tick);
    });

    // keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if(e.key === ' '){ e.preventDefault(); detectPoint(); }
      if(e.key === 'c'){ continuousToggle.checked = !continuousToggle.checked; }
      if(e.key === 'l'){ lockEnabled = !lockEnabled; lockPointBtn.textContent = `Lock Point: ${lockEnabled? 'On' : 'Off'}`; }
    });

    // load persisted history on start
    loadHistory();
  </script>
</body>
</html>
